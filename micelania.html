<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MICELANIA</title>
    <link rel="stylesheet" href="./bootstrap/css/bootstrap.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Montserrat:wght@100;200;300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <style>
        body {
            padding: 24px;
            font-family: 'Montserrat', sans-serif;
            font-weight: 400;
            background-color: white;
            color: rgb(184, 142, 140);
            position: relative;
        }

        .base_page {
            background-image: url('./assets/img/bottom-right.svg'), url('./assets/img/top-right.svg'), url('./assets/img/bottom-left.svg'), url('./assets/img/top-left.svg'), url('./assets/img/horizontals.png'), url('./assets/img/verticals.png'), url('./assets/img/horizontals.png'), url('./assets/img/verticals.png');
            background-position: bottom right, top right, bottom left, top left, top, left, bottom, right;
            background-size: 140px, 140px, 140px, 140px, 100px 2.8px, 2.8px, 100px 2.8px, 2.6px;
            background-repeat: no-repeat, no-repeat, no-repeat, no-repeat, repeat-x, repeat-y, repeat-x, repeat-y;
            max-width: 380px;
        }

        .base_title {
            font-size: 40px;
            font-weight: 100;
        }

        .main_open {
            padding-top: 72px;
            padding-bottom: 72px;
            height: fit-content !important;
            min-height: 100%;
            position: relative;
        }

        .btn-primary,
        .btn-primary:hover,
        .btn-primary:active,
        .btn-primary:focus,
        .btn-primary:focus-within {
            background-color: rgb(184, 142, 140);
            color: #FFFFFF;
            outline: none;
            border: none;
            box-shadow: none;
        }

        .forms {
            width: 100%;
            margin: 0 auto;
            max-width: 330px;
        }

        .forms .btn {
            text-align: left;
        }

        .procedure {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .procedure label {
            color: #2C2E35;
        }

        #results {
            width: 100%;
            max-width: 330px;
            display: flex;
            flex-direction: column;
            text-align: left;
            align-items: start;
            font-weight: 400;
            gap: 4px;
            color: rgb(184, 142, 140);
        }

        #results h6 {
            font-size: 20px;
        }

        #results p {
            color: rgb(184, 142, 140);
            font-size: 18px;
            margin: 0;
        }

        .form-check .form-check-input[type="checkbox"]:checked {
            background-color: #DFC6C5;
            border-color: #DFC6C5;
        }

        .label_file {
            position: relative;
            display: flex;
            flex-direction: row;
            gap: 8px;
        }

        .label_file::before {
            content: '';
            width: 24px;
            height: 24px;
            align-items: center;
            display: block;
            background-repeat: no-repeat;
            background-size: cover;
            background-position: center;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%232C2E35' class='bi bi-camera' viewBox='0 0 16 16'%3E%3Cpath d='M15 12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V6a1 1 0 0 1 1-1h1.172a3 3 0 0 0 2.12-.879l.83-.828A1 1 0 0 1 6.827 3h2.344a1 1 0 0 1 .707.293l.828.828A3 3 0 0 0 12.828 5H14a1 1 0 0 1 1 1v6zM2 4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2h-1.172a2 2 0 0 1-1.414-.586l-.828-.828A2 2 0 0 0 9.172 2H6.828a2 2 0 0 0-1.414.586l-.828.828A2 2 0 0 1 3.172 4H2z'/%3E%3Cpath d='M8 11a2.5 2.5 0 1 1 0-5 2.5 2.5 0 0 1 0 5zm0 1a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7zM3 6.5a.5.5 0 1 1-1 0 .5.5 0 0 1 1 0z'/%3E%3C/svg%3E");
        }

        #back_button {
            position: absolute;
            margin-top: auto;
            margin-right: auto;
            bottom: 5%;
        }

        footer {
            left: 0;
            bottom: 2px;
        }

        .upload-status {
            font-size: 30px !important;
        }
    </style>
</head>

<body>
    <div class="container base_page">
        <div id="main_container" class="d-flex flex-column h-100 gap-3 justify-content-center align-items-center">
            <a id="logo">
                <img src="./assets/img/logo.png" width="300" />
            </a>
            <h1 class="base_title">
                Misceláneas
            </h1>
            <div id="results">

            </div>
            <div class="flex-column gap-2 forms" id="procedure" style="display: none;">
                <div id="name_section" class="procedure">
                    <button class="btn btn-primary" id="nombre">NOMBRE</button>
                </div>
                <div id="procedimiento_section" class="procedure group-b">
                    <button class="btn btn-primary" id="procedimiento">PROCEDIMIENTO</button>
                </div>
            </div>
            <div class="mt-5 d-block w-100"></div>
            <button id="back_button" style="display: none;" class="btn btn-primary">Back</button>
        </div>
    </div>
    <footer class="position-absolute bottom-0 text-center w-100">
        <p class="mb-0 w-100">DERMABLESS ALL RIGHT RESERVED</p>
    </footer>
    <script src="./bootstrap/js/jquery-3.6.3.min.js"></script>
    <script src="./bootstrap/js/bootstrap.min.js"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/gasparesganga-jquery-loading-overlay@2.1.7/dist/loadingoverlay.min.js"></script>
    <script src="./js/heic2any.js"></script>
    <script>
        const states = [];
        let especStatus = 0;
        let liftingStatus = 0;
        let remocionStatus = 0;
        let selectedSatus = 0;
        let esList = [
            ["Lisbet", "Dianelys", "Daniela", "Laura", "Susan", "Irianys"],
            ["Lisbet", "Dianelys", "Daniela", "Laura", "Claudia", "Irianys", "Susan"],
            ["Yanisbel", "Yariela", "Laura"],
            ["Lisbet", "Dianelys", "Daniela", "Laura", "Claudia", "Susan", "Yanisbel", "Lien"],
            ["Irianys", "Laura", "Susan"],
            ["Lien", "Irianys", "Laura", "Susan"],
            ["Yanisbel"]
        ];

        var formData = new FormData();

        const padStart = function (text, length = 2, replacedString = '0') {
            let newText = text + '';
            while (newText.length < length) {
                newText = replacedString + newText;
            }
            return newText;
        }

        const sendRequest = function () {
            if (selectedSatus != 1) {
                formData.append("inicio", $("#inicial_pic_file").get(0).files[0]);
                formData.append("final", $("#final_pic_file").get(0).files[0]);
            }
            formData.append("status", selectedSatus);

            $.ajax({
                xhr: function () {
                    var xhr = new window.XMLHttpRequest();

                    xhr.upload.addEventListener("progress", function (evt) {
                        if (evt.lengthComputable) {
                            var percentComplete = evt.loaded / evt.total;
                            percentComplete = parseInt(percentComplete * 100);

                            $(".upload-status").text("Uploading...(" + percentComplete + "%)");
                        }
                    }, false);

                    return xhr;
                },
                // url: 'https://dermaforms.prodev.app/generate/micelania',
                url: 'https://easyform.dermabless.com/generate/micelania',
                cache: false,
                contentType: false,
                processData: false,
                data: formData,
                type: 'POST',
                dataType: "json",
                success: function (res) {
                    alert(res.message)
                },
                error: function (error) {
                    console.log(error);
                }
            });
        }

        const start = function () {
            $('#logo').hide();
            $('#main_container').addClass('main_open');
            $('#main_container').removeClass('justify-content-center');
            $('#procedure').attr('style', 'display: flex;');
        }

        const capitalLetter = function (str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        const createCheckbox = function (id, label, container = false) {
            return $(`<div class="form-check">
                    <input class="form-check-input" type="checkbox" value="" id="${id}">
                    <label class="form-check-label" for="${id}">${label}</label></div>
                    
        ` + (container ? `<div id="${id}_container"></div>` : ''));
        }

        const createInput = function (id, placeholder = "") {
            return $(`<input class="form-control" placeholder="${placeholder}" name="${id}" id="${id}">`);
        }

        const createFileInput = function (id) {
            return $(`<label id="${id}_label" class="label_file">Accion de tomar<input id="${id}" type="file" style="visibility: hidden; position: absolute" accept="image/png, image/gif, image/jpeg"></label>`);
        }

        const convertHeicToJpg = function (input) {
            var oldFile = $(input).val().split('\\').pop();
            var oldFileName = oldFile.substr(0, oldFile.lastIndexOf('.')) || oldFile;

            var fileName = $(input).val();
            var fileNameExt = fileName.substr(fileName.lastIndexOf('.') + 1);
            if (fileNameExt == "heic") {
                var blob = $(input)[0].files[0]; //ev.target.files[0];
                heic2any({
                    blob: blob,
                    toType: "image/png",
                }).then(function (resultBlob) {
                    var url = URL.createObjectURL(resultBlob);
                    $(input).parent().find(".upload-file").css("background-image", "url(" + url + ")"); //previewing the uploaded picture
                    //adding converted picture to the original <input type="file">
                    let fileInputElement = $(input)[0];
                    let container = new DataTransfer();
                    let file = new File([resultBlob], oldFileName + ".png", { type: "image/png", lastModified: new Date().getTime() });
                    container.items.add(file);

                    fileInputElement.files = container.files;
                })
                    .catch(function (x) {
                        console.log(x.code);
                        console.log(x.message);
                    });
            }
        }

        let toFriendlyID = function (label) {
            return label.replace(new RegExp('( )', 'g'), '_').replace(new RegExp('/', 'g'), '_').toLowerCase();
        }

        const clearFormDataItem = function (key) {
            formData.delete(key);
        }

        const Nombre = function () {
            if (!document.querySelector('#full_name')) {
                $('#name_section').append('<input id="full_name" name="full_name" type="text" class="form-control">')
                $('#full_name').change(function () {
                    let val = $(this).val();

                    if (val) {
                        const name = val.split(" ");
                        let nombre = "";
                        for (i in name) {
                            nombre += capitalLetter(name[i]) + " ";
                        }
                        let date = new Date();
                        const time = `${padStart(date.getHours())}:${padStart(date.getMinutes())}`;

                        clearFormDataItem("name");
                        formData.append("name", nombre);

                        clearFormDataItem("time");
                        formData.append("time", time);

                        $('#results').append(`<h6>${nombre}</h6>`);

                        $('#name_section').hide();
                        Procedimiento();
                    }
                });
            }
        }

        const createProCheckboxList = function (flag = false) {
            const backTxtId = "proce_txt";
            const subSelector = (flag == 1 ? "#modificacion_sub" : "#procedimiento_sub");
            const subId = (flag == 1 ? "modificacion_sub" : "procedimiento_sub");
            const sectionId = (flag == 1 ? "#modificacion_section" : "#procedimiento_section");
            const formDataId = (flag == 1 ? "modify" : "procedimiento");
            let date = new Date();
            const generate_date = `${padStart(date.getMonth() * 1 + 1)}/${padStart(date.getDate())}/${date.getFullYear()}`;
            const time = `${padStart(date.getHours())}:${padStart(date.getMinutes())}`;
            const modeTxt = (flag == 1 ? " (MOD)" : "") + " <span id='date_time_txt'>" + generate_date + " " + time + "</span>";

            clearFormDataItem("date");
            formData.append("date", generate_date);

            clearFormDataItem("send_time");
            formData.append("send_time", time);

            if (document.querySelector(subSelector) || !formData.get("name")) {
                return;
            }

            $(sectionId).append('<div id="' + subId + '" class="procedure"></div>');

            if (!flag || (flag && especStatus != 0)) {
                let henna = createCheckbox('henna', 'Henna');
                $(subSelector).append(henna);
            }
            if (!flag || (flag && especStatus != 1)) {
                let cejas = createCheckbox('pinza', 'Cejas con Pinza');
                $(subSelector).append(cejas);
            }
            if (!flag || (flag && especStatus != 2)) {
                let dental = createCheckbox('dental', 'Blanqueamiento Dental');
                $(subSelector).append(dental);
            }
            let wax = createCheckbox('wax', 'Wax');
            let lifting = createCheckbox('lifting', 'Lifting');
            let parafina = createCheckbox('parafina', 'Parafina');
            let remocion = createCheckbox('remocion', 'Remoción');

            $(subSelector).append(wax);
            $(subSelector).append(lifting);
            $(subSelector).append(parafina);
            $(subSelector).append(remocion);

            $(["#henna", "#pinza", "#dental"]).each(function (index, item) {
                $(item).change(function () {
                    especStatus = index;
                    let selectedId = $(this).attr("id");
                    let selectedText = $("label[for='" + selectedId + "']").text();
                    clearFormDataItem(formDataId);
                    formData.append(formDataId, selectedText.toUpperCase());
                    $("#" + backTxtId).remove();
                    $('#results').append(`<p id="${backTxtId}">${selectedText}${modeTxt}</p>`);
                    if (flag) {
                        $(subSelector).empty();
                        createMotivoCambio()
                    } else {
                        $(sectionId).remove();
                    }
                    Modificacion();
                    Especialista();
                    ImageGroup();
                });
            });
            $("#wax").change(function () {
                if ($(this).prop('checked')) {
                    $(subSelector).empty();
                    let subLabels = ['Wax de Cejas', 'Wax de Labio Superior', 'Wax de Barbilla'];

                    subLabels.forEach(function (label) {
                        if (flag && formData.get("procedimiento") == "Wax Of " + label) return false;
                        $(subSelector).append(createCheckbox(toFriendlyID(label), label));
                        $('#' + toFriendlyID(label)).click(function () {
                            $("#" + backTxtId).remove();
                            $('#results').append(`<p id="${backTxtId}">${"" + label}${modeTxt}</p>`);
                            if (flag) {
                                $(subSelector).empty();
                                createMotivoCambio();
                            } else {
                                $(sectionId).remove();
                            }
                            clearFormDataItem(formDataId);
                            formData.append(formDataId, "Wax Of " + label);
                            especStatus = 3;
                            Modificacion();
                            Especialista();
                            Consentimiento();
                        });
                    })
                }

            });
            $("#lifting").change(function () {
                if ($(this).prop('checked')) {
                    $(subSelector).empty();
                    let subLabels = ['Lifting de Cejas', 'Lifting de Pestañas',];
                    subLabels.forEach(function (label, pIndex) {
                        if (flag && formData.get("procedimiento") == label) return false;
                        $(subSelector).append(createCheckbox(toFriendlyID(label), label));
                        $('#' + toFriendlyID(label)).click(function () {
                            $("#" + backTxtId).remove();
                            $('#results').append(`<p id="${backTxtId}">${"" + label}${modeTxt}</p>`);
                            if (flag) {
                                $(subSelector).empty();
                                createMotivoCambio()
                            } else {
                                $(sectionId).remove();
                            }
                            clearFormDataItem(formDataId);
                            formData.append(formDataId, label);
                            especStatus = 4;
                            liftingStatus = pIndex;
                            Especialista();
                            Modificacion();
                            if (pIndex) {
                                Tamano();
                                PostService();
                            } else {
                                ImageGroup();
                            }
                        });
                    })
                }
            });
            $("#parafina").change(function () {
                if ($(this).prop('checked')) {
                    $(subSelector).empty();
                    let subLabels = ['Parafina De Manos', 'Parafina De Pies'];
                    subLabels.forEach(function (label) {
                        if (flag && formData.get("procedimiento") == label) return false;
                        $(subSelector).append(createCheckbox(toFriendlyID(label), label));
                        $('#' + toFriendlyID(label)).click(function () {
                            $("#" + backTxtId).remove();
                            $('#results').append(`<p id="${backTxtId}">${"" + label}${modeTxt}</p>`);
                            if (flag) {
                                $(subSelector).empty();
                                createMotivoCambio();
                            } else {
                                $(sectionId).remove();
                            }
                            clearFormDataItem(formDataId);
                            formData.append(formDataId, "Parafina " + label);
                            especStatus = 5;
                            Modificacion();
                            Especialista();
                            PostService();
                        });
                    })
                }
            });
            $("#remocion").change(function () {
                if ($(this).prop('checked')) {
                    $(subSelector).empty();
                    let subLabels = ['Remocion de Tattoo por enzimas', 'Remocion de Tattoo por laser', 'Remocion de Cejas por enzimas', 'Remocion de Cejas por laser'];
                    subLabels.forEach(function (label, rIndex) {
                        if (flag && formData.get("procedimiento") == label) return false;
                        $(subSelector).append(createCheckbox(toFriendlyID(label), label));
                        $('#' + toFriendlyID(label)).click(function () {
                            if (flag) {
                                $(subSelector).empty();
                                createMotivoCambio();
                            } else {
                                $(subSelector).empty();
                            }
                            $("#" + backTxtId).remove();
                            $('#results').append(`<p id="${backTxtId}">${label}${modeTxt}</p>`);
                            $(sectionId).remove();
                            clearFormDataItem(formDataId);
                            formData.append(formDataId, label);

                            especStatus = 6;
                            remocionStatus = rIndex * 1 + 1;
                            Modificacion();
                            Especialista();
                            Consentimiento();
                        });
                    })
                }
            });
        }

        const Procedimiento = function () {
            createProCheckboxList();
        }

        const Modificacion = function () {
            if (document.querySelector('#modificacion_section') || formData.get("modify")) {
                return;
            }

            $("#procedure").append('<div id="modificacion_section" class="procedure group-b"><button class="btn btn-primary" id="modificacion">MODIFICACION</button></div>');

            $("#modificacion").click(function () {
                if (document.querySelector('#modificacion_sub')) {
                    return;
                }

                createProCheckboxList(true);
            });

        }

        const createMotivoCambio = function () {
            const ele = createInput("reason_input", "Motivo del cambio");
            $("#modificacion_section").append(ele);

            $("#reason_input").blur(function () {
                let inputVal = $(this).val();
                clearFormDataItem("motivo_cambio_reason");
                formData.append("motivo_cambio_reason", inputVal);
                $("#modificacion_section").remove();
            });
        }
        const Consentimiento = function () {
            if (document.querySelector('#consentimiento_section')) {
                return false;
            }

            $("#procedure").append('<div id="consentimiento_section" class="procedure"><button class="btn btn-primary" id="consentimiento">CONSENTIMIENTO</button></div>');

            $("#consentimiento").click(function () {
                $("#consentimiento_section").append('<div id="consentimiento_sub_section" class="procedure"></div>');
                if (document.querySelector('#documento_firmado')) {
                    return false;
                }
                let documento_firmado = $(`<div class="form-check">
                    <input class="form-check-input" type="checkbox" value="" id="documento_firmado">
                    <label class="form-check-label" for="documento_firmado">
                        Documento Firmado
                    </label>
                </div>`)
                let allergy = $(`<div class="form-check">
                    <input class="form-check-input" type="checkbox" value="" id="padece_de_alergia">
                    <label class="form-check-label" for="padece_de_alergia">
                        Reacciones previas
                    </label></div>
                    <div id="alergia_container"></div>
                `);
                let no_allergy = $(`<div class="form-check" style="margin-top: -8px">
                    <input class="form-check-input" type="checkbox" value="" id="no_padece_de_alergia">
                    <label class="form-check-label" for="no_padece_de_alergia">
                        No consentimiento
                    </label></div>
                `);

                $('#consentimiento_sub_section').append(documento_firmado, allergy, no_allergy);

                $('#documento_firmado').change(function () {
                    if ($(this).prop('checked')) {
                        // clearFormDataItem("consentimiento");
                        // formData.append("consentimiento", "Documento Firmado");
                        $('#consentimiento_sub_section').empty();;

                        $("#consentimiento_sub_section").append(createInput("fecha_documento", "Fecha documento anterior"));
                        $("#consentimiento_sub_section").append(createCheckbox("firmado_hoy", "Consentimiento firmado hoy"));

                        $("#fecha_documento").blur(function () {
                            clearFormDataItem("consentimiento");
                            formData.append("consentimiento", $(this).val());
                            $("#consentimiento_section").remove();
                        });
                        $("#firmado_hoy").change(function () {
                            clearFormDataItem("consentimiento");
                            formData.append("consentimiento", "Consentimiento firmado hoy");
                            $("#consentimiento_section").remove();
                        });
                    }
                });
                $('#no_padece_de_alergia').change(function () {
                    if ($(this).prop('checked')) {
                        clearFormDataItem("consentimiento");
                        formData.append("consentimiento", "No consentimiento");
                        clearFormDataItem("alergia");
                        formData.append("alergia", "No");

                        $('#consentimiento_section').hide();
                    }
                });
                $('#padece_de_alergia').change(function () {
                    if ($(this).prop('checked')) {
                        clearFormDataItem("consentimiento");
                        formData.append("consentimiento", "");
                        if (!document.querySelector('alergia')) {
                            $('#alergia_container').append(`<input id="alergia" name="alergia" type="text" class="form-control">`);
                            $('#alergia').change(function () {
                                let val = $(this).val();
                                if (val) {
                                    clearFormDataItem("alergia");
                                    formData.append("alergia", val);

                                    $('#consentimiento_section').hide();
                                }
                            });
                        }
                    } else {
                        $('#alergia').remove();
                    }
                });
            });
            checkShowImageGroup();
        }

        const Especialista = function () {
            if (document.querySelector('#especialista_section')) {
                return;
            }

            $("#procedure").append('<div id="especialista_section" class="procedure group-b"><button class="btn btn-primary" id="especialista">ESPECIALISTA</button></div>');

            $("#especialista").click(function () {
                if (!formData.get("modify")) $("#modificacion_section").hide();

                const labels = esList[especStatus];
                labels.forEach(function (label) {
                    $('#especialista_section').append(createCheckbox(toFriendlyID(label), label));
                    $('#' + toFriendlyID(label)).click(function () {
                        let date = new Date();
                        const ddate = `${padStart(date.getMonth() * 1 + 1)}/${padStart(date.getDate())}/${date.getFullYear()}`;
                        const time = `${padStart(date.getHours())}:${padStart(date.getMinutes())}`;
                        $("#especialista_section").remove();
                        clearFormDataItem("especialista");
                        formData.append("especialista", label + " " + time);
                        $("#date_time_txt").text(ddate + " " + time);
                    });
                })
            });
        }

        const checkShowImageGroup = function () {
            // IF Especialista is selected Parafina, move to ANOTACIONES GENERALES
            if (especStatus == 5) {
                selectedSatus = 1;
                PostService();
            } else {
                ImageGroup();
            }
        }

        const ImageGroup = function () {
            if (document.querySelector('#image_group')) {
                return;
            }

            $('#procedure').append('<div id="image_group" class="procedure group-image"></div>')
            $('#image_group').append('<div class="procedure"><button class="btn btn-primary" id="inicial_pic">INICIAL PIC</button></div>');
            $('#image_group').append('<div class="procedure"><button class="btn btn-primary" id="final_pic">FINAL PIC</button></div>');

            $(['inicial_pic', 'final_pic']).each(function (i, id) {
                $('#' + id).click(function () {
                    if (!document.getElementById(id + '_file')) {
                        $('#' + id).parent().append(createFileInput(id + '_file'));
                        $('#' + id + '_file').change(function (e) {
                            convertHeicToJpg(this);
                            $('#' + id).parent().hide();

                            if ($("#inicial_pic_file").val() && $("#final_pic_file").val()) {

                                if (remocionStatus == 1 || remocionStatus == 3) {
                                    selectedSatus = 3;
                                    RemocionEnzimas();
                                } else if (remocionStatus == 2 || remocionStatus == 4) {
                                    selectedSatus = 4;
                                    RemocionLaser();
                                }
                                PostService();
                            }
                        });

                        $('#' + id + '_file').click()
                    }
                });
            });
        }

        const Tamano = function () {
            if (document.querySelector('#tamno_section')) {
                return;
            }
            $('#procedure').append('<div class="procedure" id="tamno_section"><button class="btn btn-primary" id="tamano_molde">TAMAÑO DE MOLDE</button></div>');
            $("#tamano_molde").click(function () {
                if (document.querySelector('#small')) {
                    return;
                }

                ["Small", "Medium", "Large"].forEach(function (label) {
                    $('#tamno_section').append(createCheckbox(toFriendlyID(label), label));
                    $('#' + toFriendlyID(label)).click(function () {
                        $('#tamno_section').empty();

                        clearFormDataItem("tamno");
                        formData.append("tamno", label.toUpperCase());

                        PostService();
                    });
                })
            });
        }

        const RemocionEnzimas = function () {
            if (document.querySelector('#remocionenzimas_section')) {
                return;
            }

            $('#procedure').append('<div id="remocionenzimas_section" class="procedure"></div>')

            $('#remocionenzimas_section').append('<div id="remocionenzimas_section_sub_1" class="procedure"><button class="btn btn-primary" id="enzimas_sesion">SESION</button></div>');
            $('#remocionenzimas_section').append('<div id="remocionenzimas_section_sub_2" class="procedure"><button class="btn btn-primary" id="enzimas_base">BASE</button></div>');
            $('#remocionenzimas_section').append('<div id="remocionenzimas_section_sub_3" class="procedure"><button class="btn btn-primary" id="enzimas_tipo">TIPO DE PIEL</button></div>');

            $("#enzimas_sesion").click(function () {
                if (document.querySelector('#enzimas_sesion_input')) {
                    return;
                }
                $('#remocionenzimas_section_sub_1').append(createInput('enzimas_sesion_input'));
                $('#enzimas_sesion_input').change(function () {
                    clearFormDataItem("enzimas_sesion");
                    formData.append("enzimas_sesion", $(this).val());
                });

                $("#enzimas_sesion_input").blur(function () {
                    $('#remocionenzimas_section_sub_1').remove();
                });
            });
            $("#enzimas_base").click(function () {
                if (document.querySelector('#roja')) {
                    return;
                }
                const labels = ["Roja", "Gris", "Morada", "Verde"];
                labels.forEach(function (label) {
                    $('#remocionenzimas_section_sub_2').append(createCheckbox(toFriendlyID(label), label));
                    $('#' + toFriendlyID(label)).click(function () {
                        $("#remocionenzimas_section_sub_2").remove();
                        clearFormDataItem("enzimas_base");
                        formData.append("enzimas_base", label.toUpperCase());
                    });
                })
            });

            $("#enzimas_tipo").click(function () {
                if (document.querySelector('#enzimas_tipo_1')) {
                    return;
                }
                for (var i = 1; i <= 5; i++) {
                    const tipoId = "enzimas_tipo_" + i;
                    let checkboxObj = createCheckbox(tipoId, i);
                    $("#remocionenzimas_section_sub_3").append(checkboxObj)

                    $("#" + tipoId).change(function () {
                        if ($(this).prop('checked')) {
                            $(remocionenzimas_section_sub_3).empty();

                            let subLabels = (i == 5 ? ['1 pasadas', '2 pasadas'] : ['2 pasadas', '3 pasadas', '4 pasadas']);

                            subLabels.forEach(function (label) {
                                const subId = tipoId + ' ' + label;
                                $("#remocionenzimas_section_sub_3").append(createCheckbox(toFriendlyID(subId), label));
                                $('#' + toFriendlyID(subId)).click(function () {
                                    clearFormDataItem("enzimas_tipo");
                                    formData.append("enzimas_tipo", subId);
                                    $("#remocionenzimas_section_sub_3").remove();
                                });
                            })
                        }
                    });
                }
            });

        }

        const RemocionLaser = function () {
            if (document.querySelector('#remocionlaser_section')) {
                return;
            }

            $('#procedure').append('<div id="remocionlaser_section" class="procedure"></div>')

            $('#remocionlaser_section').append('<div id="remocionlaser_section_sub_1" class="procedure"><button class="btn btn-primary" id="laser_area">AREA</button></div>');
            $('#remocionlaser_section').append('<div id="remocionlaser_section_sub_2" class="procedure"><button class="btn btn-primary" id="laser_sesion">SESION</button></div>');
            $('#remocionlaser_section').append('<div id="remocionlaser_section_sub_3" class="procedure"><button class="btn btn-primary" id="laser_base">BASE</button></div>');
            $('#remocionlaser_section').append('<div id="remocionlaser_section_sub_4" class="procedure"><button class="btn btn-primary" id="laser_forto">FOTOTIPO DE PIEL</button></div>');
            $('#remocionlaser_section').append('<div id="remocionlaser_section_sub_5" class="procedure"><button class="btn btn-primary" id="laser_frec">FRECUENCIA</button></div>');
            $('#remocionlaser_section').append('<div id="remocionlaser_section_sub_6" class="procedure"><button class="btn btn-primary" id="laser_intent">INTENSIDAD</button></div>');
            $('#remocionlaser_section').append('<div id="remocionlaser_section_sub_7" class="procedure"><button class="btn btn-primary" id="laser_disparos">DISPAROS</button></div>');

            $("#laser_area").click(function () {
                if (document.querySelector('#cejas')) {
                    return;
                }
                const labels = ["Cejas", "Brazo izquierdo", "Brazo derecho", "Pierna izquierda", "Pierna derecha", "Hombro izquierdo",
                    "Hombro derecho", "Mano izquierda", "Mano derecha", "Espalda", "Pecho", "Cuello", "Pelvis", "Gluteos"];
                labels.forEach(function (label) {
                    $('#remocionlaser_section_sub_1').append(createCheckbox(toFriendlyID(label), label));
                    $('#' + toFriendlyID(label)).click(function () {
                        $("#remocionlaser_section_sub_1").remove();
                        clearFormDataItem("laser_area");
                        formData.append("laser_area", label.toUpperCase());
                        PostService();
                    });
                })
            });
            $("#laser_sesion").click(function () {
                if (document.querySelector('#laser_sesion_1')) {
                    return;
                }
                for (var i = 6; i >= 1; i--) {
                    const sesionId = "laser_sesion_" + i;
                    let checkboxObj = createCheckbox(sesionId, i);
                    $("#remocionlaser_section_sub_2").append(checkboxObj)

                    $('#' + sesionId).click(function () {
                        clearFormDataItem("laser_sesion");
                        formData.append("laser_sesion", sesionId);
                        $("#remocionlaser_section_sub_2").remove();
                        PostService();
                    });
                }
            });
            $("#laser_base").click(function () {
                if (document.querySelector('#negra')) {
                    return;
                }
                const labels = ["Negra", "Gris"];
                labels.forEach(function (label) {
                    $('#remocionlaser_section_sub_3').append(createCheckbox(toFriendlyID(label), label));
                    $('#' + toFriendlyID(label)).click(function () {
                        $("#remocionlaser_section_sub_3").remove();
                        clearFormDataItem("laser_base");
                        formData.append("laser_base", label);
                        PostService();
                    });
                })
            });
            $("#laser_forto").click(function () {
                if (document.querySelector('#laser_forto_1')) {
                    return;
                }
                for (var i = 1; i <= 4; i++) {
                    const pielId = "laser_forto_" + i;
                    let checkboxObj = createCheckbox(pielId, i);
                    $("#remocionlaser_section_sub_4").append(checkboxObj)

                    $('#' + pielId).click(function () {
                        clearFormDataItem("laser_forto");
                        formData.append("laser_forto", pielId);
                        $("#remocionlaser_section_sub_4").remove();
                        PostService();
                    });
                }
            });
            $("#laser_frec").click(function () {
                if (document.querySelector('#laser_frec_input')) {
                    return;
                }
                $('#remocionlaser_section_sub_5').append(createInput('laser_frec_input'));
                $('#laser_frec_input').change(function () {
                    clearFormDataItem("laser_frec");
                    formData.append("laser_frec", $(this).val());
                });

                $("#laser_frec_input").blur(function () {
                    $('#remocionlaser_section_sub_5').remove();
                    PostService();
                });
            });
            $("#laser_intent").click(function () {
                if (document.querySelector('#laser_intent_input')) {
                    return;
                }
                $('#remocionlaser_section_sub_6').append(createInput('laser_intent_input'));
                $('#laser_intent_input').change(function () {
                    clearFormDataItem("laser_intent");
                    formData.append("laser_intent", $(this).val());
                });

                $("#laser_intent_input").blur(function () {
                    $('#remocionlaser_section_sub_6').remove();
                    PostService();
                });
            });
            $("#laser_disparos").click(function () {
                if (document.querySelector('#laser_disparos_input')) {
                    return;
                }
                $('#remocionlaser_section_sub_7').append(createInput('laser_disparos_input'));
                $('#laser_disparos_input').change(function () {
                    clearFormDataItem("laser_disparos");
                    formData.append("laser_disparos", $(this).val());
                });

                $("#laser_disparos_input").blur(function () {
                    $('#remocionlaser_section_sub_7').remove();
                    PostService();
                });
            });

        }

        const PostService = function (remo = 0) {
            if (document.querySelector('#post_section')) {
                return false;
            }

            $('#procedure').append('<div id="post_section" class="procedure group-c"></div>')

            $('#post_section').append('<div id="post_service_sub_1" class="procedure"><button class="btn btn-primary" id="anotaciones_generales">ANOTACIONES GENERALES</button></div>');
            $('#post_section').append('<div id="post_service_sub_2" class="procedure"><button class="btn btn-primary" id="product_adicion">PRODUCTOS</button></div>');
            $('#post_section').append('<div id="post_service_sub_3" class="procedure"><button class="btn btn-primary" id="servicio_furtros">SERVICIO FUTUROS</button></div>');

            $("#product_adicion").click(function () {
                if (document.querySelector('#product_adicion_input')) {
                    return;
                }
                $('#post_service_sub_2').append(createInput('product_adicion_input'));
                $('#product_adicion_input').change(function () {
                    clearFormDataItem("product_adicion");
                    formData.append("product_adicion", $(this).val());
                    $('#post_service_sub_2').hide();
                });

                $("#product_adicion_input").blur(function () {
                    CierreProcedimiento();
                    $('#post_service_sub_2').hide();
                });
            });
            $("#servicio_furtros").click(function () {
                if (document.querySelector('#servicio_furtros_input')) {
                    return;
                }
                $('#post_service_sub_3').append(createInput('servicio_furtros_input'));
                $('#servicio_furtros_input').change(function () {
                    clearFormDataItem("servicio_furtros");
                    formData.append("servicio_furtros", $(this).val());
                    $('#post_service_sub_3').hide();
                });

                $("#servicio_furtros_input").blur(function () {
                    CierreProcedimiento();
                });
            });
            $("#anotaciones_generales").click(function () {
                if (document.querySelector('#anotaciones_generales_section_sub')) return;

                $('#post_service_sub_1').append(createInput('anotaciones_generales_input'));
                $('#anotaciones_generales_input').change(function () {
                    clearFormDataItem("anotaciones_generales");
                    formData.append("anotaciones_generales", $(this).val());
                    $('#post_service_sub_1').hide();
                });

                $("#anotaciones_generales_input").blur(function () {
                    CierreProcedimiento();
                    $('#post_service_sub_1').hide();
                });

            });

        }

        const CierreProcedimiento = function () {
            if (document.querySelector('#cierre_procedimiento')) {
                return;
            }

            $('#procedure').append('<div id="cierre_procedimiento" class="procedure"></div>')
            $('#cierre_procedimiento').append('<div id="" class="procedure"><button class="btn btn-primary" id="enviar">ENVIAR</button></div>');

            $('#enviar').click(function () {
                sendRequest();
            });
        }

        $(document).ready(function () {
            $('#back_button').click(function () {
                if (states.length) {
                    let func = states.pop();
                    func();
                }
            });

            $('#main_container').click(function () {
                start();
            });

            const name = localStorage.getItem("name");
            const date = localStorage.getItem("date");

            if (name && date) {
                start();
                $('#results').append(`<h6>${name}</h6>`);
                $('#results').append(`<p>${date}</p>`);
            }

            $('#procedimiento').click(function () {
                Procedimiento();
            });

            $('#nombre').click(function () {
                Nombre();
            });

            $.LoadingOverlaySetup({
                background: "rgba(255, 255, 255, 0.8)",
                backgroundClass: "",
                image: "<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1000 1000'><circle r='80' cx='500' cy='90'/><circle r='80' cx='500' cy='910'/><circle r='80' cx='90' cy='500'/><circle r='80' cx='910' cy='500'/><circle r='80' cx='212' cy='212'/><circle r='80' cx='788' cy='212'/><circle r='80' cx='212' cy='788'/><circle r='80' cx='788' cy='788'/></svg>",
                imageAnimation: "2000ms rotate_right",
                imageAutoResize: true,
                imageResizeFactor: 1,
                imageColor: "#202020",
                imageClass: "",
                imageOrder: 1,
                // Text
                text: "Uploading...",
                textAnimation: "",
                textAutoResize: true,
                textResizeFactor: 0.5,
                textColor: "#202020",
                textClass: "upload-status",
                textOrder: 4,
                // Progress
                progress: true,
                progressAutoResize: true,
                progressResizeFactor: 0.25,
                progressColor: "#a0a0a0",
                progressClass: "",
                progressOrder: 5,
                progressFixedPosition: "",
                progressSpeed: 200,
                progressMin: 0,
                progressMax: 100,
                // Sizing
                size: 50,
                maxSize: 120,
                minSize: 20,
                // Misc
                direction: "column",
                fade: true,
                resizeInterval: 50,
                zIndex: 2147483647
            });
        });

        $(document).ajaxStart(function () {
            $.LoadingOverlay("show");
        });
        $(document).ajaxStop(function () {
            $.LoadingOverlay("hide");
        });
    </script>
</body>

</html>